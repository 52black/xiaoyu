const express=require('express');const User=require('../models/user');const Unrel=require('../models/unreleased');const Works=require('../models/works');const path=require('path');const fs=require('fs');const multer=require('multer');const router=express['Router']();let pagetitle='Scratch3.0创作\x20-\x20小幽编程';function guid(){var _0x211d51={'QKFdt':function(_0x3e37e3,_0x5168cd){return _0x3e37e3|_0x5168cd;},'SZCNr':function(_0x686e5b,_0xc24c31){return _0x686e5b*_0xc24c31;},'zIJUe':function(_0x298127,_0x46af0e){return _0x298127+_0x46af0e;},'wEjlH':function(_0x35f8c9,_0x196260){return _0x35f8c9+_0x196260;},'kllLm':function(_0x40322d){return _0x40322d();}};function _0x94de36(){return _0x211d51['QKFdt'](_0x211d51['SZCNr'](_0x211d51['zIJUe'](0x1,Math['random']()),0x10000),0x0)['toString']()['substring'](0x1);}return _0x211d51['wEjlH'](_0x211d51['kllLm'](_0x94de36),_0x211d51['kllLm'](_0x94de36));}router['get']('/',function(_0xdd801b,_0x5c8123,_0x3bdd51){var _0x121a0f={'XInTA':'scratch'};let _0x12e03f=_0xdd801b['session']['user'];if(_0x12e03f){_0x5c8123['locals']['user']=_0x12e03f;let _0x465198=_0x5c8123['locals']['user']['_id'];Unrel['find']({'user':_0x465198})['sort']({'meta.updateAt':-0x1})['exec'](function(_0x3e3775,_0x89d119){_0x89d119=JSON['stringify'](_0x89d119);_0x5c8123['render'](_0x121a0f['XInTA'],{'title':pagetitle,'worksdata':_0x89d119});});}else{_0x5c8123['render'](_0x121a0f['XInTA'],{'title':pagetitle,'worksdata':''});}});var save_storage=multer['diskStorage']({'destination':function(_0x248c9c,_0x4906d2,_0x509593){var _0x1e8577={'cchTm':function(_0x47c3c8,_0x11fba7,_0x158e68){return _0x47c3c8(_0x11fba7,_0x158e68);},'uvUsa':function(_0xb4e6ea,_0x4762db){return _0xb4e6ea+_0x4762db;},'MntGb':function(_0x52d821,_0x728df1){return _0x52d821+_0x728df1;},'Mcgqn':'public/unreleased/'};_0x1e8577['cchTm'](_0x509593,null,_0x1e8577['uvUsa'](_0x1e8577['MntGb'](_0x1e8577['Mcgqn'],_0x4906d2['fieldname']),'/'));},'filename':function(_0x3d51f0,_0xa5cf48,_0x5df9bb){var _0xe18083={'svepT':function(_0xe82f3a,_0x4af131,_0x3c3933){return _0xe82f3a(_0x4af131,_0x3c3933);},'DUGnd':function(_0x117233,_0x4ff53c){return _0x117233+_0x4ff53c;},'BXIdO':function(_0x4ce49f){return _0x4ce49f();}};_0xe18083['svepT'](_0x5df9bb,null,_0xe18083['DUGnd'](_0xe18083['BXIdO'](guid),Date['now']()));}});var savefile=multer({'storage':save_storage});var save_file=savefile['fields']([{'name':'scratch','maxCount':0x1},{'name':'covers','maxCount':0x1}]);router['post']('/files/savenew',save_file,function(_0x522ef7,_0x1ace3a,_0x45d7a8){var _0x21e754={'QypXw':'success','FosKf':'保存成功','UCpEM':function(_0x3e92e0,_0xd4e347){return _0x3e92e0!==_0xd4e347;},'PVfHM':'undefined','EjirT':function(_0x42c1ff,_0x42bfaa){return _0x42c1ff+_0x42bfaa;},'bjvyL':'./public/unreleased/scratch/','gxQRG':'fail','sApbj':'请先登录'};let _0x31c252=_0x522ef7['session']['user'];let _0x473631=_0x522ef7['files'];const _0x4b393e=_0x473631['scratch'][0x0]['filename'];const _0xf2cca8=_0x473631['covers'][0x0]['filename'];const _0x62a830=_0x522ef7['body']['userid'];const _0x4a074c=_0x522ef7['body']['filenames'];if(_0x62a830&&_0x21e754['UCpEM'](_0x62a830,_0x21e754['PVfHM'])&&_0x4a074c){let _0x30c2ea=new Unrel({'title':_0x4a074c,'user':_0x62a830,'localsname':_0x4b393e,'covers':_0xf2cca8});_0x30c2ea['save'](function(_0x2374fa,_0x42ebee){if(_0x2374fa){console['log'](_0x2374fa);}_0x1ace3a['send']({'status':_0x21e754['QypXw'],'newfile':_0x42ebee,'msg':_0x21e754['FosKf']});});}else{fs['unlink'](_0x21e754['EjirT'](_0x21e754['bjvyL'],_0x4b393e),function(_0x5f5c40){if(_0x5f5c40){console['log'](_0x5f5c40);}});_0x1ace3a['send']({'status':_0x21e754['gxQRG'],'msg':_0x21e754['sApbj']});}});router['post']('/files/saveold',save_file,function(_0x19e0fe,_0x574794,_0x4649f9){var _0xd88db0={'ARqbn':'success','XFinZ':'保存成功','AzKib':function(_0x324f33,_0x1eb629){return _0x324f33+_0x1eb629;},'ZmVWU':'./public/unreleased/scratch/','wautr':'./public/unreleased/covers/','ieyyX':function(_0x1e28bc,_0x2d93d2){return _0x1e28bc&&_0x2d93d2;},'lfOuO':'fail','leVrN':'请先登录'};let _0x1deccc=_0x19e0fe['files'];const _0x3385ec=_0x1deccc['scratch'][0x0]['filename'];const _0x491464=_0x1deccc['covers'][0x0]['filename'];const _0x1042c=_0x19e0fe['body']['filelists_localsid'];const _0x195004=_0x19e0fe['body']['filelists_title'];const _0x48fee3=_0x19e0fe['body']['filelists_local'];const _0x132b9d=_0x19e0fe['body']['filelists_covers'];if(_0xd88db0['ieyyX'](_0x1042c,_0x195004)&&_0x48fee3){Unrel['updateById'](_0x1042c,_0x195004,_0x3385ec,_0x491464,function(_0x44b513,_0x430ef5){if(_0x44b513){console['log'](_0x44b513);}_0x574794['send']({'status':_0xd88db0['ARqbn'],'newlocals':{'title':_0x195004,'localsname':_0x3385ec},'msg':_0xd88db0['XFinZ']});fs['unlink'](_0xd88db0['AzKib'](_0xd88db0['ZmVWU'],_0x48fee3),function(_0x1d3499){if(_0x1d3499){console['log'](_0x1d3499);}});fs['unlink'](_0xd88db0['AzKib'](_0xd88db0['wautr'],_0x132b9d),function(_0x2b1686){if(_0x2b1686){console['log'](_0x2b1686);}});});}else{_0x574794['send']({'status':_0xd88db0['lfOuO'],'msg':_0xd88db0['leVrN']});}});var rel_storage=multer['diskStorage']({'destination':function(_0x51c52b,_0x1c4847,_0x2b6b86){var _0x3e0fef={'BTBGb':function(_0x1a2145,_0x1e5e8f,_0x5548b1){return _0x1a2145(_0x1e5e8f,_0x5548b1);},'DKIkJ':function(_0x4acf8a,_0x51b601){return _0x4acf8a+_0x51b601;},'HFhJn':'public/released/'};_0x3e0fef['BTBGb'](_0x2b6b86,null,_0x3e0fef['DKIkJ'](_0x3e0fef['DKIkJ'](_0x3e0fef['HFhJn'],_0x1c4847['fieldname']),'/'));},'filename':function(_0x4e8edb,_0x1121ac,_0x3cda6e){var _0x3287ae={'foDmh':function(_0x3d68cc,_0x32e1e3,_0x150e0d){return _0x3d68cc(_0x32e1e3,_0x150e0d);},'ZkGdi':function(_0x10d93c,_0x7ffcc5){return _0x10d93c+_0x7ffcc5;},'nOsfi':function(_0x5e62b9){return _0x5e62b9();}};_0x3287ae['foDmh'](_0x3cda6e,null,_0x3287ae['ZkGdi'](_0x3287ae['nOsfi'](guid),Date['now']()));}});var relfile=multer({'storage':rel_storage});var released_file=relfile['fields']([{'name':'scratch','maxCount':0x1},{'name':'covers','maxCount':0x1}]);router['post']('/files/released',released_file,function(_0x1abd42,_0x43759d,_0x17d461){var _0x14f01f={'QeMpa':'success','GVikF':'发布成功','HQJOT':function(_0x278490,_0xc9fb85){return _0x278490&&_0xc9fb85;},'NifAI':function(_0x39302e,_0x315717){return _0x39302e==_0x315717;},'QyOzm':function(_0x31ac9f,_0x8159f7){return _0x31ac9f&&_0x8159f7;},'jLLCR':'fail','PNxgd':'请先登录','TaylW':function(_0x2eb015,_0x4543b1){return _0x2eb015==_0x4543b1;},'TPioE':'false'};let _0x47e871=_0x1abd42['session']['user'];let _0x295a75=_0x1abd42['files'];const _0x296852=_0x295a75['scratch'][0x0]['filename'];const _0x27c25a=_0x1abd42['body']['userid'];const _0xe4c314=_0x1abd42['body']['filetitle'];const _0x5afe6f=_0x1abd42['body']['fileabstract'];const _0xc5163d=_0x1abd42['body']['fileexplain'];const _0xb342e5=_0x1abd42['body']['tags'];let _0x1917bb=_0x1abd42['body']['fileonly'];if(_0x14f01f['TaylW'](_0x1917bb,_0x14f01f['TPioE'])){_0x1917bb=![];}else{_0x1917bb=!![];};console['log'](_0x1917bb);const _0x5a91a7=_0x1abd42['body']['localsid'];const _0x13ddbb=_0x295a75['covers'][0x0]['filename'];const _0x52043b=_0x1abd42['body']['oldwid'];Works['findOne']({'_id':_0x52043b})['exec'](function(_0x184cda,_0xd4a6c1){var _0xd832ee={'Aheal':_0x14f01f['QeMpa'],'VKVLO':_0x14f01f['GVikF']};if(_0x14f01f['HQJOT'](_0x52043b,_0xd4a6c1)&&_0x14f01f['NifAI'](_0xd4a6c1['user'],_0x27c25a)){if(_0x14f01f['QyOzm'](_0x27c25a,_0xe4c314)&&_0x5afe6f){let _0x1aa045={'worksid':_0x296852,'title':_0xe4c314,'abstract':_0x5afe6f,'explain':_0xc5163d,'isOnly':_0x1917bb,'tags':_0xb342e5['split'](','),'covers':_0x13ddbb};Works['updateByWid'](_0x52043b,_0x1aa045,function(_0x8913b){if(_0x8913b){console['log'](_0x8913b);}_0x43759d['send']({'status':_0x14f01f['QeMpa'],'worksid':_0x52043b,'msg':_0x14f01f['GVikF']});});}else{_0x43759d['send']({'status':_0x14f01f['jLLCR'],'msg':_0x14f01f['PNxgd']});}}else{if(_0x14f01f['QyOzm'](_0x27c25a,_0xe4c314)&&_0x5afe6f){let _0x4d4d01=new Works({'user':_0x27c25a,'worksid':_0x296852,'title':_0xe4c314,'abstract':_0x5afe6f,'explain':_0xc5163d,'isOnly':_0x1917bb,'tags':_0xb342e5['split'](','),'covers':_0x13ddbb});_0x4d4d01['save'](function(_0x5c5770,_0x47de9c){if(_0x5c5770){console['log'](_0x5c5770);}_0x43759d['send']({'status':_0xd832ee['Aheal'],'worksid':_0x47de9c['_id'],'msg':_0xd832ee['VKVLO']});if(_0x5a91a7){Unrel['remove']({'_id':_0x5a91a7})['exec'](function(_0x37dd5f){if(_0x37dd5f){console['log'](_0x37dd5f);}});}});}else{_0x43759d['send']({'status':_0x14f01f['jLLCR'],'msg':_0x14f01f['PNxgd']});}}});});router['post']('/loadfiles',function(_0x3b50bf,_0x4ca0e8,_0x40bade){var _0x351fa1={'ZSkZM':'../public/unreleased/scratch/','YvZCR':'fail'};const _0x32cac4=_0x3b50bf['body']['fileid'];if(_0x32cac4){_0x4ca0e8['sendFile'](path['join'](__dirname,_0x351fa1['ZSkZM'],_0x32cac4));}else{_0x4ca0e8['send']({'status':_0x351fa1['YvZCR']});}});router['get']('/downloads',function(_0x25ec32,_0x3c8271,_0x10466f){var _0x34edc4={'QHWhD':function(_0x1576ac,_0x328f87){return _0x1576ac+_0x328f87;},'VKwjJ':'public/unreleased/scratch/','uGmid':'fail'};const _0x46e7ed=_0x25ec32['query']['fileid'];if(_0x46e7ed){_0x3c8271['download'](_0x34edc4['QHWhD'](_0x34edc4['VKwjJ'],_0x46e7ed),_0x46e7ed);}else{_0x3c8271['send']({'status':_0x34edc4['uGmid']});}});router['get']('/download/released',function(_0x2cb454,_0x1c0f88,_0x1e92da){var _0x31b61d={'qNGtr':function(_0x3702bf,_0xf05f90){return _0x3702bf+_0xf05f90;},'pAagC':'public/released/scratch/','fEiVw':'fail'};const _0x503c35=_0x2cb454['query']['fileid'];if(_0x503c35){_0x1c0f88['download'](_0x31b61d['qNGtr'](_0x31b61d['pAagC'],_0x503c35),_0x503c35);}else{_0x1c0f88['send']({'status':_0x31b61d['fEiVw']});}});router['get']('/download/released/:id',function(_0x441a24,_0x28e24e,_0x4ad915){var _0x2626b2={'dSmcB':function(_0x1774a9,_0x1cad84){return _0x1774a9+_0x1cad84;},'AYwEd':'public/released/scratch/','LpWuT':'fail'};const _0xe945ae=_0x441a24['params']['id'];if(_0xe945ae){_0x28e24e['download'](_0x2626b2['dSmcB'](_0x2626b2['AYwEd'],_0xe945ae),_0xe945ae);}else{_0x28e24e['send']({'status':_0x2626b2['LpWuT']});}});router['get']('/loadReleaseMsg/:id',function(_0x27d54b,_0x42db9a,_0x3459c1){var _0x5a1f93={'dUjyp':'success','yhtnz':'fail'};const _0x5a70c7=_0x27d54b['params']['id'];if(_0x5a70c7){Works['find']({'worksid':_0x5a70c7})['exec'](function(_0xc0a464,_0x5e1fd8){_0x42db9a['send']({'status':_0x5a1f93['dUjyp'],'msg':_0x5e1fd8[0x0]});});}else{_0x42db9a['send']({'status':_0x5a1f93['yhtnz']});}});module['exports']=router;