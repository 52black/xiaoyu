const express=require('express');const Banner=require('../models/banner');const User=require('../models/user');const Works=require('../models/works');const Ufollow=require('../models/ufollow');const Suggest=require('../models/suggest');const FeedBack=require('../models/feedback');const Notice=require('../models/notice');const crypto=require('crypto');const router=express['Router']();const moment=require('moment');moment['locale']('zh-CN');let govname='小幽编程';let pagetitle='小幽编程\x20-\x20Scratch\x203.0\x20少儿编程社区';router['get']('/',function(_0x5f9479,_0x4d7169,_0x2dd0d8){var _0x2cecd7={'eInor':'index','TKnuA':'user','nDYgp':'headimg\x20nickname'};let _0x213b95=_0x5f9479['session']['user'];if(_0x213b95){_0x4d7169['locals']['user']=_0x213b95;}Banner['find']({})['exec'](function(_0x98f9c2,_0x1feb5a){var _0x186a7f={'ygrUq':_0x2cecd7['eInor'],'suTgO':_0x2cecd7['TKnuA'],'yHqGI':_0x2cecd7['nDYgp']};Works['find']({})['sort']({'zan':-0x1})['limit'](0xa)['populate'](_0x2cecd7['TKnuA'],_0x2cecd7['nDYgp'])['exec'](function(_0x4c63aa,_0x4f3fff){if(_0x4c63aa){console['log'](_0x4c63aa);}Works['find']({})['sort']({'keep':-0x1})['limit'](0xa)['populate'](_0x186a7f['suTgO'],_0x186a7f['yHqGI'])['exec'](function(_0x7b881d,_0x280665){var _0x35f58f={'PRwQb':_0x186a7f['ygrUq']};if(_0x7b881d){console['log'](_0x7b881d);}Works['find']({})['sort']({'meta.createAt':-0x1})['limit'](0xa)['populate'](_0x186a7f['suTgO'],_0x186a7f['yHqGI'])['exec'](function(_0x40d2de,_0x51bc44){_0x4d7169['render'](_0x35f58f['PRwQb'],{'title':pagetitle,'banners':_0x1feb5a,'hotlist':_0x4f3fff,'keeplist':_0x280665,'newlist':_0x51bc44});});});});});});router['get']('/ourjob',function(_0x1071e1,_0x1c9918,_0x3dbf26){var _0x424c77={'bdkdB':'support'};let _0x8e68c9=_0x1071e1['session']['user'];if(_0x8e68c9){_0x1c9918['locals']['user']=_0x8e68c9;}_0x1c9918['render'](_0x424c77['bdkdB'],{'title':pagetitle});});router['post']('/signin',function(_0x3b9060,_0x5773bb,_0x5591d4){var _0x681c4b={'cZVtU':'fail','DSnzU':'服务器抢修中，暂时无法登陆','TmBdP':function(_0x1cf5f9,_0x4c0cbd){return _0x1cf5f9==_0x4c0cbd;},'TCXEl':'nouser','qzAGK':'账号或密码错误','keUbE':function(_0xe84986,_0x574fce){return _0xe84986==_0x574fce;},'ZRDGz':'由于您的不当言论，账号已被禁封','aygcf':'success','iFOdc':'pwderror','DgWmo':'sha1','DXEOB':function(_0x5579fd,_0x4ba3b9){return _0x5579fd&&_0x4ba3b9;},'GQFFo':'xiaou','diQEQ':'hex'};const _0x2f2b7b=crypto['createHash'](_0x681c4b['DgWmo']);const _0x540669=_0x3b9060['body']['username'];const _0x5b946b=_0x3b9060['body']['userpwd'];if(_0x681c4b['DXEOB'](_0x540669,_0x5b946b)){const _0x34918f=_0x2f2b7b['update'](_0x681c4b['GQFFo'])['update'](_0x5b946b)['digest'](_0x681c4b['diQEQ']);User['fetchByName'](_0x540669,function(_0x44d4ed,_0x31206e){if(_0x44d4ed){console['log'](_0x44d4ed);_0x5773bb['send']({'status':_0x681c4b['cZVtU'],'msg':_0x681c4b['DSnzU']});}else{if(_0x681c4b['TmBdP'](_0x31206e['length'],0x0)){_0x5773bb['send']({'status':_0x681c4b['TCXEl'],'msg':_0x681c4b['qzAGK']});}else{if(_0x681c4b['TmBdP'](_0x34918f,_0x31206e[0x0]['password'])){if(_0x681c4b['keUbE'](_0x31206e[0x0]['status'],-0x1)){_0x5773bb['send']({'status':_0x681c4b['cZVtU'],'msg':_0x681c4b['ZRDGz']});}else{_0x3b9060['session']['user']=_0x31206e[0x0];_0x5773bb['send']({'status':_0x681c4b['aygcf']});}}else{_0x5773bb['send']({'status':_0x681c4b['iFOdc'],'msg':_0x681c4b['qzAGK']});}}}});}});router['post']('/register',function(_0x243501,_0x60295b,_0x3f6c29){var _0x33517e={'eyGhR':'success','YKuaN':'fail','ujmvF':'欢迎来到小幽编程社区','EYDNE':'【欢迎来你到小幽编程社区】很高兴你能成为我们的一员，在这里你将体验不一样的编程乐趣，我们搭载了最新的\x20scratch3.0，赶紧去体验吧！','LyKDl':function(_0x84904c,_0x1c6946){return _0x84904c(_0x1c6946);},'Afuch':'服务器抢修中，暂时无法注册','MrRVn':function(_0x55d7a6,_0x5f3366){return _0x55d7a6==_0x5f3366;},'ZmyyJ':'/img/headimg/person-icon.png','zzgHj':'喔~\x20hohohoho','WzJcJ':'该账号已被其他用户注册','wJVQE':'sha1','ZRsJq':function(_0x3c9e8d,_0x24e5df){return _0x3c9e8d&&_0x24e5df;},'iAYfe':'xiaou','qAbQn':'hex'};const _0x71660=crypto['createHash'](_0x33517e['wJVQE']);const _0x58382c=_0x243501['body']['username'];const _0x24a366=_0x243501['body']['nickname'];const _0x4e5489=_0x243501['body']['userpwd'];let _0x55275e;if(_0x33517e['ZRsJq'](_0x58382c,_0x4e5489)){const _0x562f36=_0x71660['update'](_0x33517e['iAYfe'])['update'](_0x4e5489)['digest'](_0x33517e['qAbQn']);User['fetchByName'](_0x58382c,function(_0x4f8f12,_0x5b433a){if(_0x4f8f12){console['log'](_0x4f8f12);_0x60295b['send']({'status':_0x33517e['YKuaN'],'msg':_0x33517e['Afuch']});}else{if(_0x33517e['MrRVn'](_0x5b433a['length'],0x0)){_0x55275e=new User({'username':_0x58382c,'password':_0x562f36,'nickname':_0x24a366,'realname':'','headimg':_0x33517e['ZmyyJ'],'email':'','phoneNum':'','qq':'','wx':'','motto':_0x33517e['zzgHj'],'noticenum':0x1});_0x55275e['save'](function(_0x5359e7,_0x5aece3){var _0x52889e={'kDiwe':_0x33517e['eyGhR']};if(_0x5359e7){console['log'](_0x5359e7);_0x60295b['send']({'status':_0x33517e['YKuaN']});}else{_0x243501['session']['user']=_0x5aece3;let _0x1c0982=new Notice({'user':_0x5aece3['_id'],'message':[{'title':_0x33517e['ujmvF'],'content':_0x33517e['EYDNE'],'createAt':_0x33517e['LyKDl'](moment,new Date())['format']('LL')}]});_0x1c0982['save'](function(_0x8394d){var _0x5f3575={'LKyAV':_0x52889e['kDiwe']};if(_0x8394d){console['log'](_0x8394d);}let _0x138293=new Ufollow({'userid':_0x5aece3['_id']});_0x138293['save'](function(_0x226584){if(_0x226584){console['log'](_0x226584);}_0x60295b['send']({'status':_0x5f3575['LKyAV']});});});}});}else{_0x60295b['send']({'status':_0x33517e['YKuaN'],'msg':_0x33517e['WzJcJ']});}}});}});function hashpwd(_0x422b40){var _0x5a0045={'NPCDF':'sha1','dLpSq':'xiaou','Jwiln':'hex'};const _0x323759=crypto['createHash'](_0x5a0045['NPCDF']);return _0x323759['update'](_0x5a0045['dLpSq'])['update'](_0x422b40)['digest'](_0x5a0045['Jwiln']);}router['post']('/users/change/password',function(_0x49586a,_0x19800d,_0x403f26){var _0x144163={'EngxP':'success','PfWun':function(_0x11be1c,_0x31275c){return _0x11be1c==_0x31275c;},'zpqKP':function(_0x30da95,_0x2e19ea){return _0x30da95(_0x2e19ea);},'JZDRq':'fail','CRmaI':'旧密码错误','GjCut':'sha1','PsSNg':function(_0x5c237f,_0x5ca60b){return _0x5c237f&&_0x5ca60b;},'qtIop':'修改失败'};const _0x5212be=_0x49586a['body']['old_pwd'];const _0x484ccf=_0x49586a['body']['new_pwd'];const _0x24f071=crypto['createHash'](_0x144163['GjCut']);let _0x55de77=_0x49586a['session']['user'];if(_0x144163['PsSNg'](_0x55de77,_0x5212be)&&_0x484ccf){User['findOne']({'_id':_0x55de77['_id']})['exec'](function(_0x1b2202,_0x228950){if(_0x1b2202)console['log'](_0x1b2202);if(_0x144163['PfWun'](_0x228950['password'],_0x144163['zpqKP'](hashpwd,_0x5212be))){User['updateOne']({'_id':_0x55de77['_id']},{'$set':{'password':_0x144163['zpqKP'](hashpwd,_0x484ccf)}})['exec'](function(_0x18631f){_0x19800d['send']({'status':_0x144163['EngxP']});});}else{_0x19800d['send']({'status':_0x144163['JZDRq'],'msg':_0x144163['CRmaI']});}});}else{_0x19800d['send']({'status':_0x144163['JZDRq'],'msg':_0x144163['qtIop']});}});router['get']('/logout',function(_0x383545,_0x35e6e4,_0x4a705a){delete _0x383545['session']['user'];_0x35e6e4['redirect']('/');});router['get']('/aboutus',function(_0x2d6e8a,_0x11e582,_0xaf9fb3){var _0x493a99={'CfCXX':'aboutus'};let _0x4a7143=_0x2d6e8a['session']['user'];if(_0x4a7143){_0x11e582['locals']['user']=_0x4a7143;}_0x11e582['render'](_0x493a99['CfCXX'],{'title':pagetitle});});router['get']('/suggest',function(_0x5c30cf,_0x4e4c27,_0x3aaacb){var _0x182329={'vMPWL':'suggest'};let _0x13c000=_0x5c30cf['session']['user'];if(_0x13c000){_0x4e4c27['locals']['user']=_0x13c000;}_0x4e4c27['render'](_0x182329['vMPWL'],{'title':pagetitle});});router['post']('/user/suggest',function(_0x48a028,_0x57f1dc,_0x4dd467){var _0x14689f={'cWKtq':'success','ZwRDT':'fail'};let _0x2eeee6={'user':_0x48a028['body']['userid'],'content':_0x48a028['body']['content']};if(_0x2eeee6['content']&&_0x2eeee6['user']){new Suggest(_0x2eeee6)['save'](function(_0x3d82bb){if(_0x3d82bb){console['log'](_0x3d82bb);}_0x57f1dc['send']({'status':_0x14689f['cWKtq']});});}else{_0x57f1dc['send']({'status':_0x14689f['ZwRDT']});}});router['get']('/feedback',function(_0x2d57eb,_0x297e68,_0x50466e){var _0x2fb4bb={'xdhqO':'feedback'};let _0x353079=_0x2d57eb['session']['user'];if(_0x353079){_0x297e68['locals']['user']=_0x353079;}_0x297e68['render'](_0x2fb4bb['xdhqO'],{'title':pagetitle});});router['post']('/user/feedback',function(_0x4d91c2,_0x4ec1ad,_0x5a48d1){var _0x59e120={'hszEw':'success','ZgpYd':'fail'};let _0x34650c={'user':_0x4d91c2['body']['userid'],'content':_0x4d91c2['body']['content']};if(_0x34650c['content']&&_0x34650c['user']){new FeedBack(_0x34650c)['save'](function(_0x1374a8){if(_0x1374a8){console['log'](_0x1374a8);}_0x4ec1ad['send']({'status':_0x59e120['hszEw']});});}else{_0x4ec1ad['send']({'status':_0x59e120['ZgpYd']});}});module['exports']=router;